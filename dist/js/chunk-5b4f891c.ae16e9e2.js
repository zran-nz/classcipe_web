(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-5b4f891c"],{"28ca":function(t,e,a){"use strict";a("681d")},"681d":function(t,e,a){},"6f40":function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"my-full-form-wrapper",attrs:{id:"formRoot"}},[i("fixed-form-header",{scopedSlots:t._u([{key:"header",fn:function(){return[i("form-header",{attrs:{title:t.title,"show-share":!1,"show-collaborate":!1,"is-preview-mode":!0},on:{back:t.goBack},scopedSlots:t._u([{key:"back",fn:function(){return[i("img",{staticClass:"single-logo-img",attrs:{src:a("be50"),alt:"classcipe"},on:{click:function(e){return e.stopPropagation(),t.$router.push("/")}}})]},proxy:!0},{key:"left",fn:function(){return[i("a-space",{attrs:{size:5,align:"center"},on:{click:function(t){t.stopPropagation()}}},[i("label",{staticStyle:{cursor:"pointer"},on:{click:function(e){return t.$router.push("/account/info")}}},[t._v("Account Info")]),i("label",{attrs:{for:""}},[t._v(">")]),i("label",{staticStyle:{cursor:"pointer"},on:{click:function(e){return t.$router.push("/manage/student")}}},[t._v("School Student")]),i("label",{attrs:{for:""}},[t._v(">")]),i("label",{staticStyle:{"font-weight":"normal"}},[t._v(t._s(t.title))])])]},proxy:!0},{key:"right",fn:function(){},proxy:!0}])})]},proxy:!0}])}),i("div",{staticClass:"form-content"},[i("div",{staticClass:"filter-tab"},[i("a-space",[i("label",{attrs:{for:""}},[t._v("Class")]),i("a-select",{staticStyle:{margin:"0 10px",width:"170px"},model:{value:t.chooseClass,callback:function(e){t.chooseClass=e},expression:"chooseClass"}},t._l(t.classList,(function(e){return i("a-select-option",{key:"classes"+e.id,attrs:{value:e.id}},[t._v(" "+t._s(e.name)+" ")])})),1),i("a-button",{attrs:{type:"primary"},on:{click:t.goClass}},[t._v("Go to set class")])],1),i("a-space",{staticClass:"filter-opt"},[i("a-button",{attrs:{type:"primary"},on:{click:t.downloadTemplate}},[t._v("Download template")]),i("school-user-import",{attrs:{dataKey:t.dataKey,action:t.importExcelUrl},on:{success:t.handleImportGet}})],1)],1),i("div",{staticClass:"form-tab"},[i("school-user-upload",{ref:"schoolUserUpload",attrs:{columns:t.columns,datas:t.datas,verify:t.justifyStatus,verifyDuplicate:t.verifyDuplicate,options:t.uploadOptions},on:{change:t.handelChangeData,save:t.handleSave}})],1)]),i("fixed-form-footer",{scopedSlots:t._u([{key:"right",fn:function(){return[i("custom-text-button",{attrs:{label:"Add selected students"},on:{click:t.handleAddUser}})]},proxy:!0}])})],1)},s=[],n=a("1da1"),o=a("3835"),r=a("5530"),l=(a("96cf"),a("d3b7"),a("3ca3"),a("ddb0"),a("d81d"),a("b0c0"),a("a15b"),a("4de4"),a("159b"),a("ac1f"),a("1276"),a("498a"),a("7db0"),a("99af"),a("2b3d"),a("caad"),a("2532"),a("5319"),a("f93e")),c=a("6e84"),u=a("21fb"),m=a("b5ff8"),d=a("b5a9"),f=a("920f"),p=a("20ae"),h=a("1802"),E=a("85a6"),b=a("ad59"),v=a("ec09"),g=a("2f62"),y=a("c1df"),S=a.n(y),j=a("ca00"),x=a("4fcf"),O=x.debounce,I=x.mergeWith,k={name:"SchoolStudentUpload",mixins:[c["a"],u["a"]],components:{FixedFormHeader:m["a"],FixedFormFooter:f["a"],FormHeader:d["a"],CustomTextButton:p["a"],SchoolUserUpload:h["a"],SchoolUserImport:E["a"]},props:{id:{type:String,default:null},classId:{type:String,default:null}},data:function(){return{USER_MODE:l["X"],SCHOOL_USER_STATUS:l["A"],baseUrl:"https://api.classcipe.com",importExcelUrl:"",classList:[],remoteEmails:[],remoteParentEmails:[],datas:[],dataKey:["firstName","lastName","inviteEmail","birthDay","parentFirstName","parentLastName","parentEmail","parentPhone"],columns:[{title:"First Name",align:"center",dataIndex:"firstName",width:150,scopedSlots:{customRender:"firstName"}},{title:"Last Name",align:"center",dataIndex:"lastName",width:150,scopedSlots:{customRender:"lastName"}},{title:"Email",align:"center",dataIndex:"inviteEmail",width:200,scopedSlots:{customRender:"inviteEmail"}},{title:"ParentEmail",align:"center",dataIndex:"parentEmail",width:200,scopedSlots:{customRender:"parentEmail"}},{title:"Action",align:"center",scopedSlots:{customRender:"action"}}],loading:!1,uploadOptions:{classes:[]},chooseClass:this.classId}},created:function(){this.debounceLoad=O(this.loadData,300),this.initDict()},computed:Object(r["a"])(Object(r["a"])({},Object(g["e"])({userMode:function(t){return t.app.userMode},currentSchool:function(t){return t.user.currentSchool}})),{},{title:function(){return"Upload"}}),methods:{goBack:function(){this.$router.go(-1)},handleSchoolChange:function(t){this.userMode===l["X"].SCHOOL&&(this.queryParam.schoolId=t.id,this.initDict(),this.debounceInit())},handleModeChange:function(t){this.initDict(),this.debounceInit()},loadData:function(){},initDict:function(){var t=this;Promise.all([Object(b["h"])({schoolId:this.currentSchool.id,queryType:0,pageNo:1,pageSize:1e4})]).then((function(e){var a=Object(o["a"])(e,1),i=a[0];0===i.code&&(t.classList=i.result.records,t.uploadOptions.classes=i.result.records.map((function(t){return{value:t.id,label:t.name}})))}))},handelChangeData:function(t){this.datas=t,this.reJustifyInviteEmail(this.datas)},handleImportGet:function(t){var e=this,a=t.map((function(t){return t.inviteEmail})).filter((function(t){return!!t})).join(","),i={};t.filter((function(t){return!Object(j["isEmpty"])(t.parentEmail)&&Object(j["isEmail"])(t.parentEmail)})).forEach((function(t,e){i["parentEmailInfos[".concat(e,"].firstName")]=t.firstName,i["parentEmailInfos[".concat(e,"].lastName")]=t.lastName,i["parentEmailInfos[".concat(e,"].parentEmail")]=t.parentEmail})),this.loading=!0,Promise.all([Object(v["j"])({schoolId:this.currentSchool.id,emails:a}),Object(v["i"])(Object(r["a"])({schoolId:this.currentSchool.id},i))]).then((function(a){var i=Object(o["a"])(a,2),s=i[0],n=i[1];0===s.code&&(e.remoteEmails=I(e.remoteEmails,s.result)),0===n.code&&(e.remoteParentEmails=I(e.remoteParentEmails,n.result));var r=t.map((function(t){t.classes&&(t.classes=t.classes.split(",").map((function(t){var a=t.trim(),i=e.classList.find((function(t){return t.name===a}));return i?i.id:""})).filter((function(t){return!!t})).join(","));var a=e.justifyStatus(t),i={};return e.remoteParentEmails.forEach((function(t){i[t.email]=t.exists})),i[t.parentEmail]&&a.push({col:"parentEmail",msg:"Duplicate Parent"}),t.status=a,t.birthDay&&(t.birthDay=S()(t.birthDay,"DD/MM/YYYY").format("YYYY-MM-DD HH:mm:ss")),t.schoolId=e.currentSchool.id,t.key=100*Math.random()+(new Date).getTime(),t}));e.datas=e.datas.concat(r),e.reJustifyInviteEmail(e.datas)})).finally((function(){e.loading=!1}))},downloadTemplate:function(){var t=document.createElement("a");t.style.display="none";var e=this.baseUrl+"/classcipe/excel/Student_bulk_import.xlsx";t.href=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(e)},handleSave:function(t){},handleAddUser:function(){var t=this;if(this.chooseClass)if(this.$refs.schoolUserUpload.selectionRows.length>0){var e=this.$refs.schoolUserUpload.selectionRows.map((function(e){return Object(r["a"])(Object(r["a"])({},e),{},{classes:t.chooseClass})}));this.loading=!0,Object(v["e"])(e).then((function(e){0===e.code&&(t.datas=[],t.$message.success("Import successfully"),t.goBack())})).finally((function(){t.loading=!1}))}else this.$message.error("Please select at least one to import");else this.$message.error("Please select class")},reJustifyInviteEmail:function(t){var e={};t.forEach((function(t){if(Object(j["isEmail"])(t.inviteEmail))if(e[t.inviteEmail]){var a=t.status?t.status.map((function(t){return"inviteEmail"===t.col})).map((function(t){return t.msg})).filter((function(t){return!!t})):[];a.includes("Local Duplicate")||a.push("Local Duplicate"),t.status.push({col:"inviteEmail",msg:a.join(",")})}else{var i=t.status?t.status.map((function(t){return"inviteEmail"===t.col})).map((function(t){return t.msg})).filter((function(t){return!!t})).join(","):"";t.status.push({col:"inviteEmail",msg:i.replace("Local Duplicate","").split(",").filter((function(t){return!!t})).join(",")}),e[t.inviteEmail]=!0}}))},justifyStatus:function(t){var e={},a={};this.remoteEmails.forEach((function(t){e[t.email]=t.exists})),this.remoteParentEmails.forEach((function(t){a[t.email]=t.exists}));var i=[];return Object(j["isEmpty"])(t.firstName)&&i.push({col:"firstName",msg:"Invalid Name"}),Object(j["isEmpty"])(t.lastName)&&i.push({col:"lastName",msg:"Invalid Name"}),Object(j["isEmpty"])(t.inviteEmail)||Object(j["isEmail"])(t.inviteEmail)?e[t.inviteEmail]&&i.push({col:"inviteEmail",msg:"Duplicate"}):i.push({col:"inviteEmail",msg:"Invalid Email"}),!Object(j["isEmpty"])(t.parentEmail)&&Object(j["isEmail"])(t.parentEmail)||i.push({col:"parentEmail",msg:"Invalid Parent Email"}),i},verifyDuplicate:function(t){var e=this;return Object(n["a"])(regeneratorRuntime.mark((function a(){var i,s,n;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(i=[],!t.inviteEmail){a.next=6;break}return a.next=4,Object(v["j"])({schoolId:e.currentSchool.id,emails:t.inviteEmail});case 4:s=a.sent,0===s.code&&s.result&&s.result.length>0&&s.result[0].exists&&i.push({col:"inviteEmail",msg:"Duplicate"});case 6:if(!(t.firstName&&t.lastName&&t.parentEmail)){a.next=11;break}return a.next=9,Object(v["i"])({schoolId:e.currentSchool.id,"parentEmailInfos[0].firstName":t.firstName,"parentEmailInfos[0].lastName":t.lastName,"parentEmailInfos[0].parentEmail":t.parentEmail});case 9:n=a.sent,0===n.code&&n.result&&n.result.length>0&&n.result[0].exists&&i.push({col:"parentEmail",msg:"Duplicate Parent"});case 11:return a.abrupt("return",i);case 12:case"end":return a.stop()}}),a)})))()},goClass:function(){this.$router.push("/manage/class")}}},D=k,w=(a("28ca"),a("0c7c")),N=Object(w["a"])(D,i,s,!1,null,"607253f3",null);e["default"]=N.exports}}]);